<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عارض المحتوى | MoTech Cloud</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">

    <style>
        /* * ==========================================
         * 1. المتغيرات والتأسيس (Variables & Reset)
         * ==========================================
         */
        :root {
            --primary: #00d4ff;
            --secondary: #a855f7;
            --accent: #06b6d4;
            --bg-body: #020617;
            --bg-paper: #0f172a;
            --bg-glass: rgba(15, 23, 42, 0.85);
            --border-color: rgba(0, 212, 255, 0.1);
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            --code-bg: #1e293b;
        }

        [data-theme="light"] {
            --primary: #0284c7;
            --secondary: #7e22ce;
            --accent: #0ea5e9;
            --bg-body: #f8fafc;
            --bg-paper: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --border-color: rgba(0, 0, 0, 0.1);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            --code-bg: #f1f5f9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* خلفية جمالية */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 212, 255, 0.05), transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(168, 85, 247, 0.05), transparent 40%);
            z-index: -1; pointer-events: none;
        }

        /* سكرول بار مخصص */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* * ==========================================
         * 2. شريط الأدوات العلوي (Toolbar)
         * ==========================================
         */
        .toolbar {
            position: sticky; top: 0;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 25px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; box-shadow: var(--shadow);
        }

        .toolbar-left, .toolbar-right {
            display: flex; align-items: center; gap: 15px;
        }

        /* زر الرجوع */
        .back-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 10px;
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary); text-decoration: none;
            font-weight: 600; font-size: 0.95rem;
            border: 1px solid transparent; transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: var(--primary); color: #fff;
            transform: translateX(5px);
        }

        .doc-meta { display: flex; flex-direction: column; }
        .doc-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .doc-status { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }

        /* أزرار التحكم */
        .control-group {
            display: flex; background: rgba(128, 128, 128, 0.1);
            border-radius: 8px; padding: 4px; border: 1px solid var(--border-color);
        }

        .icon-btn {
            width: 32px; height: 32px; border-radius: 6px;
            border: none; background: transparent;
            color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; font-size: 1rem;
        }
        .icon-btn:hover { background: rgba(128, 128, 128, 0.1); color: var(--text-main); }
        .icon-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3); }

        /* قائمة التصدير */
        .export-dropdown { position: relative; }
        .export-btn {
            padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-main); cursor: pointer;
            font-family: inherit; font-weight: 600; display: flex; align-items: center; gap: 8px;
            transition: 0.3s;
        }
        .export-btn:hover { border-color: var(--secondary); color: var(--secondary); background: rgba(168, 85, 247, 0.05); }
        
        .dropdown-menu {
            position: absolute; top: 110%; left: 0;
            background: var(--bg-paper); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 8px; min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; flex-direction: column; gap: 5px;
            animation: fadeIn 0.2s ease;
        }
        .export-dropdown:hover .dropdown-menu { display: flex; }
        
        .dropdown-item {
            padding: 10px; border-radius: 8px; border: none;
            background: transparent; color: var(--text-main);
            text-align: right; cursor: pointer; font-family: inherit;
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .dropdown-item:hover { background: rgba(0, 212, 255, 0.1); color: var(--primary); }

        /* * ==========================================
         * 3. منطقة المحتوى (The Paper)
         * ==========================================
         */
        .container {
            max-width: 900px; margin: 40px auto; padding: 0 20px;
        }

        .paper {
            background: var(--bg-paper);
            border-radius: 24px;
            padding: 60px;
            min-height: 800px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
            transition: all 0.3s ease;
        }

        /* * ==========================================
         * 4. تنسيقات الماركدوان (Markdown Styles)
         * ==========================================
         */
        .content-body {
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        /* أحجام الخطوط الديناميكية */
        .font-s .content-body { font-size: 0.95rem; }
        .font-m .content-body { font-size: 1.1rem; }
        .font-l .content-body { font-size: 1.3rem; }
        .font-xl .content-body { font-size: 1.5rem; }

        /* وضع الكتاب (Column Layout) */
        .paper.book-mode .content-body {
            column-count: 2; column-gap: 50px;
            text-align: justify;
            column-rule: 1px solid var(--border-color);
        }
        .paper.book-mode .content-body h1,
        .paper.book-mode .content-body h2,
        .paper.book-mode .content-body pre,
        .paper.book-mode .content-body table {
            column-span: all; /* العناصر العريضة تقطع الأعمدة */
        }

        /* العناوين */
        .content-body h1 {
            font-size: 2.2rem; color: var(--primary);
            margin-bottom: 1.5rem; padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 212, 255, 0.2);
        }
        .content-body h2 {
            font-size: 1.8rem; color: var(--secondary);
            margin-top: 2rem; margin-bottom: 1rem;
        }
        .content-body h3 {
            font-size: 1.4rem; color: var(--text-main);
            margin-top: 1.5rem; font-weight: 700;
        }

        /* النصوص */
        .content-body p { margin-bottom: 1.2rem; }
        .content-body strong { color: var(--secondary); font-weight: 800; }
        .content-body em { color: var(--accent); font-style: italic; }
        
        /* القوائم */
        .content-body ul, .content-body ol {
            margin-right: 2rem; margin-bottom: 1.5rem;
        }
        .content-body li { margin-bottom: 0.5rem; }
        .content-body li::marker { color: var(--primary); }

        /* الاقتباسات */
        .content-body blockquote {
            background: rgba(168, 85, 247, 0.05);
            border-right: 4px solid var(--secondary);
            padding: 15px 20px; margin: 20px 0;
            border-radius: 8px; color: var(--text-muted);
            font-style: italic;
        }

        /* الأكواد البرمجية */
        .content-body code {
            font-family: 'Fira Code', monospace;
            background: rgba(0,0,0,0.2);
            padding: 2px 6px; border-radius: 4px;
            color: var(--accent); font-size: 0.9em;
        }
        [data-theme="light"] .content-body code { background: rgba(0,0,0,0.05); color: #d63384; }

        .content-body pre {
            background: var(--code-bg); padding: 20px;
            border-radius: 12px; overflow-x: auto;
            border: 1px solid var(--border-color);
            margin: 20px 0; position: relative;
        }
        .content-body pre code {
            background: transparent; padding: 0;
            color: inherit; border-radius: 0;
        }

        /* الجداول */
        .content-body table {
            width: 100%; border-collapse: collapse;
            margin: 25px 0; overflow: hidden;
            border-radius: 12px; border: 1px solid var(--border-color);
        }
        .content-body th, .content-body td {
            padding: 15px; text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        .content-body th {
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary); font-weight: 700;
        }
        .content-body tr:last-child td { border-bottom: none; }
        .content-body tr:hover td { background: rgba(255,255,255,0.02); }

        /* * ==========================================
         * 5. حالات التحميل والخطأ (States)
         * ==========================================
         */
        .loader-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: 400px; text-align: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-state {
            text-align: center; padding: 50px; color: #ef4444;
            display: none;
        }
        .error-state i { font-size: 4rem; margin-bottom: 15px; opacity: 0.8; }

        /* * ==========================================
         * 6. التجاوب (Media Queries)
         * ==========================================
         */
        @media (max-width: 768px) {
            .toolbar { flex-direction: column; align-items: stretch; gap: 15px; }
            .toolbar-left, .toolbar-right { justify-content: space-between; }
            .paper { padding: 30px 20px; border-radius: 0; min-height: auto; border: none; background: transparent; box-shadow: none; }
            .paper.book-mode .content-body { column-count: 1; }
            .dropdown-menu { right: 0; left: auto; }
        }

        @media print {
            .toolbar { display: none; }
            body { background: white; color: black; }
            .paper { box-shadow: none; border: none; padding: 0; }
            .content-body { font-size: 12pt; color: black; }
            a { text-decoration: none; color: black; }
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="toolbar-left">
            <a href="#" id="backBtn" class="back-btn">
                <i class="fas fa-arrow-right"></i> رجوع
            </a>
            <div class="doc-meta">
                <div class="doc-title" id="docTitle">جاري التحميل...</div>
                <div class="doc-status" id="docStatus">
                    <i class="fas fa-circle-notch fa-spin"></i> استدعاء البيانات
                </div>
            </div>
        </div>

        <div class="toolbar-right">
            <div class="control-group">
                <button class="icon-btn" onclick="setFontSize('s')" title="خط صغير">A-</button>
                <button class="icon-btn active" onclick="setFontSize('m')" title="خط متوسط">A</button>
                <button class="icon-btn" onclick="setFontSize('l')" title="خط كبير">A+</button>
            </div>

            <div class="control-group">
                <button class="icon-btn active" id="normalViewBtn" onclick="setViewMode('normal')" title="عرض عادي">
                    <i class="fas fa-file-alt"></i>
                </button>
                <button class="icon-btn" id="bookViewBtn" onclick="setViewMode('book')" title="وضع الكتاب">
                    <i class="fas fa-book-open"></i>
                </button>
            </div>

            <div class="export-dropdown">
                <button class="export-btn">
                    <i class="fas fa-download"></i> تصدير
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="exportFile('pdf')">
                        <i class="fas fa-file-pdf" style="color: #ef4444;"></i> ملف PDF
                    </button>
                    <button class="dropdown-item" onclick="exportFile('docx')">
                        <i class="fas fa-file-word" style="color: #3b82f6;"></i> ملف Word
                    </button>
                    <button class="dropdown-item" onclick="exportFile('pptx')">
                        <i class="fas fa-file-powerpoint" style="color: #f59e0b;"></i> عرض PPT
                    </button>
                    <button class="dropdown-item" onclick="exportFile('xlsx')">
                        <i class="fas fa-file-excel" style="color: #10b981;"></i> ملف Excel
                    </button>
                    <hr style="border-color: var(--border-color); margin: 5px 0;">
                    <button class="dropdown-item" onclick="exportFile('txt')">
                        <i class="fas fa-file-alt"></i> نص عادي (TXT)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="paper" id="paper">
            
            <div id="loader" class="loader-container">
                <div class="spinner"></div>
                <p style="color: var(--text-muted);">جاري معالجة المحتوى وعرضه...</p>
            </div>

            <div id="errorState" class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="errorTitle">حدث خطأ</h3>
                <p id="errorDesc">تعذر تحميل المحتوى المطلوب.</p>
                <button onclick="location.reload()" class="back-btn" style="margin: 20px auto; display: inline-flex;">
                    <i class="fas fa-sync"></i> إعادة المحاولة
                </button>
            </div>

            <div id="contentBody" class="content-body" style="display: none;">
                </div>

        </div>
    </div>

    <script>
        // ==========================================
        // 1. إدارة الحالة (State Management)
        // ==========================================
        let currentContent = '';
        let contentType = ''; // 'summary' or 'quiz'
        let contentId = '';
        let contentTitle = '';

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            // استرجاع الإعدادات المحفوظة
            loadPreferences();
            
            // تحليل الرابط لمعرفة نوع المحتوى والـ ID
            const params = new URLSearchParams(window.location.search);
            const pathParts = window.location.pathname.split('/');
            
            // يدعم الشكلين: /viewer.html?type=x&id=y  أو  /viewer/quiz/123
            if (pathParts.length > 3) {
                contentType = pathParts[2];
                contentId = pathParts[3];
            } else {
                contentType = params.get('type');
                contentId = params.get('id');
            }

            // وضع "مؤقت" لعرض النتائج مباشرة بعد الإنشاء دون حفظ
            const mode = params.get('mode');

            // ضبط زر الرجوع
            const backBtn = document.getElementById('backBtn');
            if (contentType === 'quiz') backBtn.href = '/quizzes';
            else if (contentType === 'summary') backBtn.href = '/summaries';
            else backBtn.href = '/';

            // بدء التحميل
            if (mode === 'temp') {
                loadTempContent();
            } else {
                fetchContent();
            }
        });

        // ==========================================
        // 2. تحميل البيانات (Data Fetching)
        // ==========================================
        function loadTempContent() {
            const tempResult = sessionStorage.getItem('temp_ai_result');
            if (tempResult) {
                renderContent(tempResult, 'معاينة النتيجة (غير محفوظ)');
                document.getElementById('docStatus').innerHTML = '<i class="fas fa-eye"></i> وضع المعاينة';
            } else {
                showError('لا يوجد محتوى للعرض', 'ربما انتهت صلاحية الجلسة. حاول إنشاء المحتوى مجدداً.');
            }
        }

        async function fetchContent() {
            if (!contentId || !contentType) {
                showError('رابط غير صالح', 'مفقود المعرف أو نوع المحتوى.');
                return;
            }

            try {
                // تحديد رابط API بناءً على النوع
                let endpoint = '';
                if (contentType === 'summary') endpoint = `/api/summaries/${contentId}`;
                else if (contentType === 'quiz') endpoint = `/api/quizzes/${contentId}`;
                
                // جلب البيانات الوصفية (Metadata) أولاً
                // ملاحظة: إذا كان السيرفر يعيد المحتوى مباشرة، يمكن تعديل هذا الجزء
                // سنفترض هنا أننا نجلب المحتوى (Text) مباشرة من API مخصص للمحتوى
                const contentEndpoint = `/api/${contentType}/content/${contentId}`;
                
                const response = await fetch(contentEndpoint);
                
                if (!response.ok) throw new Error('فشل الاتصال بالسيرفر');
                
                const data = await response.json(); // أو .text() حسب تصميم الباك إند
                
                // التعامل مع استجابات JSON التي تحتوي على حقل content
                let markdownText = '';
                let title = 'مستند بلا عنوان';

                if (data.success) {
                    markdownText = data.content || data.result;
                    title = data.title || (contentType === 'quiz' ? 'اختبار' : 'ملخص');
                } else {
                    // إذا كان الرد نصاً مباشراً (Fallback)
                    markdownText = typeof data === 'string' ? data : JSON.stringify(data);
                }

                renderContent(markdownText, title);
                document.getElementById('docStatus').innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> تم التحميل';

            } catch (error) {
                console.error(error);
                showError('فشل تحميل الملف', 'تأكد من اتصالك بالإنترنت أو أن الملف لا يزال موجوداً.');
            }
        }

        // ==========================================
        // 3. العرض والمعالجة (Rendering)
        // ==========================================
        function renderContent(markdown, title) {
            currentContent = markdown;
            contentTitle = title;
            
            // تحديث العنوان
            document.getElementById('docTitle').textContent = title;
            document.title = `${title} | MoTech Cloud`;

            // تحويل Markdown إلى HTML
            const contentBody = document.getElementById('contentBody');
            
            // إعدادات Marked
            marked.setOptions({
                breaks: true, // تحويل سطر جديد إلى <br>
                gfm: true,    // GitHub Flavored Markdown
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                }
            });

            contentBody.innerHTML = marked.parse(markdown);

            // إخفاء اللودر وإظهار المحتوى
            document.getElementById('loader').style.display = 'none';
            contentBody.style.display = 'block';
            contentBody.style.animation = 'fadeIn 0.5s ease';

            // تفعيل تلوين الأكواد إن وجدت
            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });
            
            // إصلاح الاتجاه الذكي (إذا كان النص إنجليزي يقلب LTR)
            const arabicCharCount = (markdown.match(/[\u0600-\u06FF]/g) || []).length;
            const totalCharCount = markdown.length;
            if (arabicCharCount < totalCharCount * 0.2 && totalCharCount > 50) {
                contentBody.style.direction = 'ltr';
                contentBody.style.textAlign = 'left';
            }
        }

        function showError(title, desc) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorDesc').textContent = desc;
            document.getElementById('docStatus').innerHTML = '<i class="fas fa-times-circle" style="color: #ef4444;"></i> خطأ';
        }

        // ==========================================
        // 4. أدوات التحكم (Controls)
        // ==========================================
        
        // تغيير حجم الخط
        function setFontSize(size) {
            const paper = document.getElementById('paper');
            // إزالة الكلاسات القديمة
            paper.classList.remove('font-s', 'font-m', 'font-l', 'font-xl');
            
            // إضافة الكلاس الجديد
            paper.classList.add(`font-${size}`);
            
            // تحديث حالة الأزرار
            document.querySelectorAll('.control-group button').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            localStorage.setItem('pref_fontSize', size);
        }

        // تغيير وضع العرض (عادي / كتاب)
        function setViewMode(mode) {
            const paper = document.getElementById('paper');
            const btnNormal = document.getElementById('normalViewBtn');
            const btnBook = document.getElementById('bookViewBtn');

            if (mode === 'book') {
                paper.classList.add('book-mode');
                btnBook.classList.add('active');
                btnNormal.classList.remove('active');
            } else {
                paper.classList.remove('book-mode');
                btnBook.classList.remove('active');
                btnNormal.classList.add('active');
            }
            
            localStorage.setItem('pref_viewMode', mode);
        }

        // تحميل التفضيلات
        function loadPreferences() {
            const fontSize = localStorage.getItem('pref_fontSize') || 'm';
            const viewMode = localStorage.getItem('pref_viewMode') || 'normal';
            
            setFontSize(fontSize);
            setViewMode(viewMode);
        }

        // ==========================================
        // 5. التصدير (Export Logic)
        // ==========================================
        async function exportFile(format) {
            if (!currentContent) return alert('لا يوجد محتوى للتصدير');

            const btn = document.querySelector('.export-btn');
            const originalText = btn.innerHTML;
            
            // تغيير أيقونة الزر للتحميل
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري التحويل...`;
            btn.style.pointerEvents = 'none';

            try {
                // إرسال الطلب إلى Microservice التحويل
                // ملاحظة: تأكد من أن مسار /api/export في السيرفر يعمل ويوجه لخدمة Pandoc
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        markdown: currentContent,
                        format: format,
                        filename: contentTitle || 'document'
                    })
                });

                if (!response.ok) throw new Error('فشل عملية التحويل في السيرفر');

                // استلام الملف كـ Blob
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // إنشاء رابط تحميل وهمي والنقر عليه
                const a = document.createElement('a');
                a.href = url;
                a.download = `${contentTitle}.${format}`; // الاسم مع الامتداد
                document.body.appendChild(a);
                a.click();
                
                // تنظيف
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error(error);
                alert('عذراً، حدث خطأ أثناء التصدير. تأكد من أن خدمة التحويل تعمل.');
            } finally {
                // استعادة الزر
                btn.innerHTML = originalText;
                btn.style.pointerEvents = 'auto';
            }
        }
    </script>
</body>
</html>
